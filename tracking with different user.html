<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>航空货物库存跟踪系统 - 带用户权限管理</title>
    <!-- 引入React和ReactDOM -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
    <!-- 引入Babel用于JSX转换 -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.22.10/babel.min.js"></script>
    <!-- 引入Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- 引入mammoth.js用于处理Word文档 -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.5.1/mammoth.browser.min.js"></script>
    <!-- 引入Supabase客户端 -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body class="bg-gray-100">
    <div id="root"></div>

    <script type="text/babel">
        // 初始化Supabase客户端
        const supabaseUrl = 'https://jipseggjegdiibadldou.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImppcHNlZ2dqZWdkaWliYWRsZG91Iiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTc0ODA5MjI3NCwiZXhwIjoyMDYzNjY4Mjc0fQ.rTJIWfni2QZyeIdfKIXRXUmxXJqJpxRGlaiQs9SG2ag';
        const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);

        // 预定义用户账号 - 初始数据，实际会存储在localStorage中
        const DEFAULT_USERS = {
            admin: {
                username: 'admin',
                password: 'admin123',
                role: 'admin',
                displayName: '管理员'
            },
            user1: {
                username: 'user1',
                password: 'user123',
                role: 'user',
                displayName: '普通用户1'
            },
            user2: {
                username: 'user2',
                password: 'user456',
                role: 'user',
                displayName: '普通用户2'
            },
            user3: {
                username: 'zhangsan',
                password: 'zhang123',
                role: 'user',
                displayName: '张三'
            }
        };

        // 获取用户数据（从localStorage）
        const getUsers = () => {
            const savedUsers = localStorage.getItem('systemUsers');
            if (savedUsers) {
                return JSON.parse(savedUsers);
            } else {
                // 如果没有保存的用户数据，使用默认值
                localStorage.setItem('systemUsers', JSON.stringify(DEFAULT_USERS));
                return DEFAULT_USERS;
            }
        };

        // 保存用户数据到localStorage
        const saveUsers = (users) => {
            localStorage.setItem('systemUsers', JSON.stringify(users));
        };

        // 修改用户密码
        const updateUserPassword = (username, newPassword) => {
            const users = getUsers();
            if (users[username]) {
                users[username].password = newPassword;
                saveUsers(users);
                return true;
            }
            return false;
        };

        // 登录组件
        const LoginForm = ({ onLogin }) => {
            const [username, setUsername] = React.useState('');
            const [password, setPassword] = React.useState('');
            const [rememberMe, setRememberMe] = React.useState(true); // 默认记住登录
            const [error, setError] = React.useState('');

            // 组件挂载时检查是否有保存的登录信息
            React.useEffect(() => {
                const savedAuth = localStorage.getItem('savedAuth');
                if (savedAuth) {
                    const authData = JSON.parse(savedAuth);
                    setUsername(authData.username);
                    setPassword(authData.password);
                    setRememberMe(true);
                }
            }, []);

            const handleLogin = (e) => {
                e.preventDefault();
                setError('');

                // 获取最新的用户数据
                const users = getUsers();
                
                // 验证用户凭据
                const user = Object.values(users).find(
                    u => u.username === username && u.password === password
                );

                if (user) {
                    // 根据记住我选项保存用户信息
                    if (rememberMe) {
                        // 保存到localStorage（持久化）
                        localStorage.setItem('currentUser', JSON.stringify(user));
                        localStorage.setItem('savedAuth', JSON.stringify({ username, password }));
                    } else {
                        // 只保存到sessionStorage（会话期间）
                        sessionStorage.setItem('currentUser', JSON.stringify(user));
                        localStorage.removeItem('savedAuth');
                    }
                    onLogin(user);
                } else {
                    setError('用户名或密码错误');
                }
            };

            return (
                <div className="min-h-screen flex items-center justify-center bg-gradient-to-br from-blue-500 to-purple-600">
                    <div className="bg-white p-8 rounded-lg shadow-2xl w-full max-w-md">
                        <h1 className="text-3xl font-bold text-center mb-6 text-gray-800">
                            航空货物库存跟踪系统
                        </h1>
                        <h2 className="text-xl text-center mb-6 text-gray-600">用户登录</h2>
                        
                        <form onSubmit={handleLogin}>
                            <div className="mb-4">
                                <label className="block text-gray-700 text-sm font-bold mb-2">
                                    用户名
                                </label>
                                <input
                                    type="text"
                                    className="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                                    placeholder="请输入用户名"
                                    value={username}
                                    onChange={(e) => setUsername(e.target.value)}
                                    required
                                />
                            </div>
                            
                            <div className="mb-6">
                                <label className="block text-gray-700 text-sm font-bold mb-2">
                                    密码
                                </label>
                                <input
                                    type="password"
                                    className="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                                    placeholder="请输入密码"
                                    value={password}
                                    onChange={(e) => setPassword(e.target.value)}
                                    required
                                />
                            </div>
                            
                            <div className="mb-4 flex items-center">
                                <input
                                    type="checkbox"
                                    id="rememberMe"
                                    checked={rememberMe}
                                    onChange={(e) => setRememberMe(e.target.checked)}
                                    className="mr-2"
                                />
                                <label htmlFor="rememberMe" className="text-gray-700 text-sm">
                                    记住我（自动保存登录信息）
                                </label>
                            </div>
                            
                            {error && (
                                <div className="mb-4 p-3 bg-red-100 border border-red-400 text-red-700 rounded">
                                    {error}
                                </div>
                            )}
                            
                            <button
                                type="submit"
                                className="w-full bg-blue-500 text-white font-bold py-2 px-4 rounded hover:bg-blue-600 transition duration-200"
                            >
                                登录
                            </button>
                        </form>
                    </div>
                </div>
            );
        };

        // 普通用户密码修改组件
        const UserPasswordManager = ({ currentUser, onPasswordChange }) => {
            const [oldPassword, setOldPassword] = React.useState('');
            const [newPassword, setNewPassword] = React.useState('');
            const [confirmPassword, setConfirmPassword] = React.useState('');
            const [error, setError] = React.useState('');
            const [success, setSuccess] = React.useState('');

            const handleChangePassword = (e) => {
                e.preventDefault();
                setError('');
                setSuccess('');

                // 验证旧密码
                const users = getUsers();
                const user = users[currentUser.username];
                
                if (!user || user.password !== oldPassword) {
                    setError('旧密码不正确');
                    return;
                }

                // 验证新密码
                if (newPassword.length < 6) {
                    setError('新密码长度至少6位');
                    return;
                }

                if (newPassword !== confirmPassword) {
                    setError('两次输入的新密码不一致');
                    return;
                }

                if (oldPassword === newPassword) {
                    setError('新密码不能与旧密码相同');
                    return;
                }

                // 更新密码
                const success = updateUserPassword(currentUser.username, newPassword);
                if (success) {
                    setSuccess('密码修改成功！');
                    setTimeout(() => {
                        onPasswordChange();
                    }, 1500);
                } else {
                    setError('密码修改失败');
                }
            };

            return (
                <form onSubmit={handleChangePassword} className="max-w-md">
                    <div className="mb-4">
                        <label className="block text-gray-700 text-sm font-bold mb-2">
                            当前用户
                        </label>
                        <p className="text-gray-600">{currentUser.displayName} ({currentUser.username})</p>
                    </div>

                    <div className="mb-4">
                        <label className="block text-gray-700 text-sm font-bold mb-2">
                            旧密码
                        </label>
                        <input
                            type="password"
                            className="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                            value={oldPassword}
                            onChange={(e) => setOldPassword(e.target.value)}
                            required
                        />
                    </div>

                    <div className="mb-4">
                        <label className="block text-gray-700 text-sm font-bold mb-2">
                            新密码
                        </label>
                        <input
                            type="password"
                            className="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                            value={newPassword}
                            onChange={(e) => setNewPassword(e.target.value)}
                            placeholder="至少6位"
                            required
                        />
                    </div>

                    <div className="mb-4">
                        <label className="block text-gray-700 text-sm font-bold mb-2">
                            确认新密码
                        </label>
                        <input
                            type="password"
                            className="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                            value={confirmPassword}
                            onChange={(e) => setConfirmPassword(e.target.value)}
                            required
                        />
                    </div>

                    {error && (
                        <div className="mb-4 p-3 bg-red-100 border border-red-400 text-red-700 rounded">
                            {error}
                        </div>
                    )}

                    {success && (
                        <div className="mb-4 p-3 bg-green-100 border border-green-400 text-green-700 rounded">
                            {success}
                        </div>
                    )}

                    <button
                        type="submit"
                        className="w-full bg-blue-500 text-white font-bold py-2 px-4 rounded hover:bg-blue-600 transition duration-200"
                    >
                        修改密码
                    </button>
                </form>
            );
        };

        // 管理员密码管理组件
        const AdminPasswordManager = ({ currentUser }) => {
            const [selectedUser, setSelectedUser] = React.useState('');
            const [newPassword, setNewPassword] = React.useState('');
            const [confirmPassword, setConfirmPassword] = React.useState('');
            const [error, setError] = React.useState('');
            const [success, setSuccess] = React.useState('');
            const [showOwnPasswordChange, setShowOwnPasswordChange] = React.useState(false);

            const users = getUsers();
            const userList = Object.values(users).filter(u => u.username !== currentUser.username);

            const handleResetPassword = (e) => {
                e.preventDefault();
                setError('');
                setSuccess('');

                if (!selectedUser) {
                    setError('请选择要重置密码的用户');
                    return;
                }

                if (newPassword.length < 6) {
                    setError('新密码长度至少6位');
                    return;
                }

                if (newPassword !== confirmPassword) {
                    setError('两次输入的密码不一致');
                    return;
                }

                // 重置密码
                const success = updateUserPassword(selectedUser, newPassword);
                if (success) {
                    setSuccess(`成功重置用户 ${users[selectedUser].displayName} 的密码！`);
                    setNewPassword('');
                    setConfirmPassword('');
                    setSelectedUser('');
                } else {
                    setError('密码重置失败');
                }
            };

            return (
                <div>
                    <div className="mb-6">
                        <button
                            onClick={() => setShowOwnPasswordChange(!showOwnPasswordChange)}
                            className="text-blue-500 hover:text-blue-700 underline"
                        >
                            {showOwnPasswordChange ? '返回用户密码重置' : '修改自己的密码'}
                        </button>
                    </div>

                    {showOwnPasswordChange ? (
                        <UserPasswordManager 
                            currentUser={currentUser} 
                            onPasswordChange={() => {
                                // 管理员修改自己的密码后也需要重新登录
                                window.location.reload();
                            }} 
                        />
                    ) : (
                        <form onSubmit={handleResetPassword} className="max-w-md">
                            <h3 className="text-lg font-medium mb-4">重置用户密码</h3>
                            
                            <div className="mb-4">
                                <label className="block text-gray-700 text-sm font-bold mb-2">
                                    选择用户
                                </label>
                                <select
                                    className="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                                    value={selectedUser}
                                    onChange={(e) => setSelectedUser(e.target.value)}
                                    required
                                >
                                    <option value="">请选择用户</option>
                                    {userList.map(user => (
                                        <option key={user.username} value={user.username}>
                                            {user.displayName} ({user.username})
                                        </option>
                                    ))}
                                </select>
                            </div>

                            <div className="mb-4">
                                <label className="block text-gray-700 text-sm font-bold mb-2">
                                    新密码
                                </label>
                                <input
                                    type="password"
                                    className="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                                    value={newPassword}
                                    onChange={(e) => setNewPassword(e.target.value)}
                                    placeholder="至少6位"
                                    required
                                />
                            </div>

                            <div className="mb-4">
                                <label className="block text-gray-700 text-sm font-bold mb-2">
                                    确认密码
                                </label>
                                <input
                                    type="password"
                                    className="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                                    value={confirmPassword}
                                    onChange={(e) => setConfirmPassword(e.target.value)}
                                    required
                                />
                            </div>

                            {error && (
                                <div className="mb-4 p-3 bg-red-100 border border-red-400 text-red-700 rounded">
                                    {error}
                                </div>
                            )}

                            {success && (
                                <div className="mb-4 p-3 bg-green-100 border border-green-400 text-green-700 rounded">
                                    {success}
                                </div>
                            )}

                            <button
                                type="submit"
                                className="w-full bg-red-500 text-white font-bold py-2 px-4 rounded hover:bg-red-600 transition duration-200"
                            >
                                重置密码
                            </button>

                            <div className="mt-4 p-3 bg-yellow-50 border border-yellow-200 rounded">
                                <p className="text-sm text-yellow-700">
                                    <strong>注意：</strong>重置密码后，该用户需要使用新密码重新登录。
                                </p>
                            </div>
                        </form>
                    )}
                </div>
            );
        };

        // 主应用组件
        const ContainerTrackingSystem = () => {
          // 用户认证状态
          const [currentUser, setCurrentUser] = React.useState(null);
          const [isAuthenticated, setIsAuthenticated] = React.useState(false);
          
          // 原有状态管理
          const [inventory, setInventory] = React.useState([]);
          const [containerNumber, setContainerNumber] = React.useState('');
          const [flightNumber, setFlightNumber] = React.useState('');
          const [date, setDate] = React.useState('');
          const [direction, setDirection] = React.useState('进港');
          const [searchTerm, setSearchTerm] = React.useState('');
          const [importFile, setImportFile] = React.useState(null);
          const [currentView, setCurrentView] = React.useState('form');
          const [validationError, setValidationError] = React.useState('');
          const [loading, setLoading] = React.useState(false);
          const [showDeleted, setShowDeleted] = React.useState(false); // 是否显示已删除记录

          // 检查用户登录状态
          React.useEffect(() => {
            // 先检查localStorage（记住我）
            const savedUser = localStorage.getItem('currentUser');
            if (savedUser) {
                const user = JSON.parse(savedUser);
                setCurrentUser(user);
                setIsAuthenticated(true);
            } else {
                // 再检查sessionStorage（会话登录）
                const sessionUser = sessionStorage.getItem('currentUser');
                if (sessionUser) {
                    const user = JSON.parse(sessionUser);
                    setCurrentUser(user);
                    setIsAuthenticated(true);
                }
            }
          }, []);

          // 处理登录
          const handleLogin = (user) => {
            setCurrentUser(user);
            setIsAuthenticated(true);
          };

          // 处理登出
          const handleLogout = () => {
            // 清除所有保存的登录信息
            localStorage.removeItem('currentUser');
            localStorage.removeItem('savedAuth');
            sessionStorage.removeItem('currentUser');
            setCurrentUser(null);
            setIsAuthenticated(false);
          };

          // 从Supabase加载数据（包括软删除的记录）
          const loadInventory = async () => {
            try {
              setLoading(true);
              let query = supabase
                .from('containers')
                .select('*')
                .order('created_at', { ascending: false });
              
              // 普通用户默认不显示已删除记录，管理员可以看到所有记录
              if (currentUser?.role === 'user' && !showDeleted) {
                query = query.or('deleted_at.is.null,deleted_by.is.null');
              }

              const { data, error } = await query;

              if (error) {
                console.error('加载数据失败:', error);
                setValidationError('加载数据失败: ' + error.message);
                return;
              }

              // 转换数据格式
              const formattedData = data.map(item => ({
                id: item.id,
                containerNumber: item.container_number,
                originalInput: item.original_input,
                flightNumber: item.flight_number,
                date: item.date,
                direction: item.direction,
                timestamp: item.created_at,
                deletedAt: item.deleted_at,
                deletedBy: item.deleted_by
              }));

              setInventory(formattedData);
            } catch (error) {
              console.error("加载数据失败:", error);
              setValidationError('加载数据失败: ' + error.message);
            } finally {
              setLoading(false);
            }
          };

          // 组件初始化时加载数据
          React.useEffect(() => {
            if (isAuthenticated) {
              loadInventory();
            }
          }, [isAuthenticated, currentUser, showDeleted]);

          // 保存数据到Supabase
          const saveToSupabase = async (newContainers) => {
            try {
              setLoading(true);
              
              // 转换数据格式为Supabase表结构
              const supabaseData = newContainers.map(container => ({
                container_number: container.containerNumber,
                original_input: container.originalInput,
                flight_number: container.flightNumber,
                date: container.date,
                direction: container.direction,
                created_by: currentUser.username // 记录创建者
              }));

              const { data, error } = await supabase
                .from('containers')
                .insert(supabaseData)
                .select();

              if (error) {
                throw error;
              }

              // 更新本地状态
              await loadInventory();
              return true;
            } catch (error) {
              console.error('保存到数据库失败:', error);
              setValidationError('保存到数据库失败: ' + error.message);
              return false;
            } finally {
              setLoading(false);
            }
          };

          // 验证箱板格式
          const validateContainerNumber = (number) => {
            if (!number) return false;
            
            const str = String(number).trim()
              .replace(/^[•·●○▪▫◦‣⁃.]/g, '')
              .replace(/^[\s\t]+/, '')
              .trim();
            
            const coreNumber = str.split('/')[0].trim();
            
            if (/NO$/i.test(coreNumber) && coreNumber.length >= 4) {
              return true;
            }
            
            return /^\d{5,6}$/.test(coreNumber) || 
                   /^AKE\d{5,6}R[79]$/i.test(coreNumber) || 
                   /^PMC\d{5,6}R[79]$/i.test(coreNumber);
          };

          // 标准化箱板号
          const normalizeContainerNumber = (number) => {
            if (!number) return '';
            
            const str = String(number).trim()
              .replace(/^[•·●○▪▫◦‣⁃.]/g, '')
              .replace(/^[\s\t]+/, '')
              .trim();
            
            const coreNumber = str.split('/')[0].trim();
            
            if (/NO$/i.test(coreNumber) && coreNumber.length >= 4) {
              return coreNumber.toUpperCase();
            }
            
            const akeMatch = coreNumber.match(/AKE(\d{5,6})R[79]/i);
            if (akeMatch) {
              return akeMatch[1];
            }
            
            const pmcMatch = coreNumber.match(/PMC(\d{5,6})R[79]/i);
            if (pmcMatch) {
              return pmcMatch[1];
            }
            
            if (/^\d{5,6}$/.test(coreNumber)) {
              return coreNumber;
            }
            
            return str;
          };

          // 获取箱板类型
          const getContainerType = (originalInput) => {
            if (!originalInput) return '数字';
            
            const str = String(originalInput).trim()
              .replace(/^[•·●○▪▫◦‣⁃.]/g, '')
              .replace(/^[\s\t]+/, '')
              .trim();
            
            if (str.endsWith('/E') || /\/.*E$/i.test(str)) {
              return '航材箱';
            }
            
            const coreNumber = str.split('/')[0].trim();
            
            if (/NO$/i.test(coreNumber)) {
              return '航材箱';
            }
            
            if (/^AKE\d{5,6}R[79]$/i.test(coreNumber)) {
              return 'AKE';
            } else if (/^PMC\d{5,6}R[79]$/i.test(coreNumber)) {
              return 'PMC';
            } else if (/^\d{5,6}$/.test(coreNumber)) {
              return '数字';
            } else {
              return '其他';
            }
          };

          // 获取标准格式的显示名称
          const getStandardDisplayName = (originalInput) => {
            if (!originalInput) return '';
            
            const str = String(originalInput).trim()
              .replace(/^[•·●○▪▫◦‣⁃.]/g, '')
              .replace(/^[\s\t]+/, '')
              .trim();
            
            const coreNumber = str.split('/')[0].trim();
            
            if (/^AKE\d{5,6}R[79]$/i.test(coreNumber) || /^PMC\d{5,6}R[79]$/i.test(coreNumber)) {
              return coreNumber.toUpperCase();
            }
            
            return coreNumber;
          };

          // 添加新箱板记录
          const handleAddContainer = async () => {
            if (!containerNumber || !flightNumber || !date) {
              setValidationError('请填写所有必填字段');
              return;
            }

            const containerNumbers = containerNumber.split(',').map(num => num.trim()).filter(num => num);
            
            if (containerNumbers.length === 0) {
              setValidationError('请输入有效的箱板号');
              return;
            }
            
            const newContainers = [];
            const errors = [];
            let skippedMaterialBoxes = 0;
            let externalOutboundCount = 0;
            
            containerNumbers.forEach(singleContainer => {
              if (!validateContainerNumber(singleContainer)) {
                errors.push(`箱板格式无效: ${singleContainer}`);
                return;
              }
              
              const containerType = getContainerType(singleContainer);
              if (containerType === '航材箱') {
                skippedMaterialBoxes++;
                console.log(`跳过航材箱: ${singleContainer}`);
                return;
              }
              
              const normalizedNumber = normalizeContainerNumber(singleContainer);
              
              if (direction === '出港') {
                const existingInbound = inventory.find(
                  item => item.containerNumber === normalizedNumber && 
                         item.direction === '进港' && 
                         !item.deletedAt // 排除已删除的记录
                );
                
                if (!existingInbound) {
                  externalOutboundCount++;
                  console.log(`外来出港箱板: ${singleContainer}`);
                }
              }
              
              newContainers.push({
                containerNumber: normalizedNumber,
                originalInput: singleContainer,
                flightNumber,
                date,
                direction
              });
            });
            
            if (errors.length > 0) {
              setValidationError(errors.join('\n'));
              return;
            }
            
            if (newContainers.length === 0) {
              setValidationError('没有有效的箱板号可以添加');
              return;
            }
            
            const success = await saveToSupabase(newContainers);
            if (success) {
              setValidationError('');
              
              setContainerNumber('');
              setFlightNumber('');
              setDate('');
              setDirection('进港');
              
              let message = `成功添加 ${newContainers.length} 条${direction}记录`;
              if (skippedMaterialBoxes > 0) {
                message += `，跳过 ${skippedMaterialBoxes} 个航材箱`;
              }
              if (externalOutboundCount > 0) {
                message += `，其中 ${externalOutboundCount} 个为外来箱板`;
              }
              alert(message);
            }
          };

          // 软删除功能（普通用户）
          const handleSoftDelete = async (id) => {
            if (!confirm('确定要删除这条记录吗？')) return;
            
            try {
              setLoading(true);
              const { error } = await supabase
                .from('containers')
                .update({ 
                  deleted_at: new Date().toISOString(),
                  deleted_by: currentUser.username
                })
                .eq('id', id);

              if (error) {
                throw error;
              }

              await loadInventory();
              alert('记录已删除（软删除）');
            } catch (error) {
              console.error('删除记录失败:', error);
              alert('删除记录失败: ' + error.message);
            } finally {
              setLoading(false);
            }
          };

          // 恢复软删除的记录（管理员功能）
          const handleRestore = async (id) => {
            if (!confirm('确定要恢复这条记录吗？')) return;
            
            try {
              setLoading(true);
              const { error } = await supabase
                .from('containers')
                .update({ 
                  deleted_at: null,
                  deleted_by: null
                })
                .eq('id', id);

              if (error) {
                throw error;
              }

              await loadInventory();
              alert('记录已恢复');
            } catch (error) {
              console.error('恢复记录失败:', error);
              alert('恢复记录失败: ' + error.message);
            } finally {
              setLoading(false);
            }
          };

          // 永久删除（管理员功能）
          const handlePermanentDelete = async (id) => {
            if (!confirm('确定要永久删除这条记录吗？此操作不可恢复！')) return;
            if (!confirm('再次确认：是否永久删除？')) return;
            
            try {
              setLoading(true);
              const { error } = await supabase
                .from('containers')
                .delete()
                .eq('id', id);

              if (error) {
                throw error;
              }

              await loadInventory();
              alert('记录已永久删除');
            } catch (error) {
              console.error('永久删除记录失败:', error);
              alert('永久删除记录失败: ' + error.message);
            } finally {
              setLoading(false);
            }
          };

          // 从文件导入数据
          const handleFileImport = (e) => {
            const file = e.target.files[0];
            setImportFile(file);
          };

          const processImport = async () => {
            if (!importFile) {
              setValidationError('请先选择文件');
              return;
            }

            if (!flightNumber || !date) {
              setValidationError('请设置默认航班号和日期（用于CSV中缺少这些信息的记录）');
              return;
            }

            try {
              // 获取文件扩展名
              const fileName = importFile.name.toLowerCase();
              const isWordFile = fileName.endsWith('.docx') || fileName.endsWith('.doc');
              
              if (isWordFile) {
                // 处理Word文档
                try {
                  const arrayBuffer = await importFile.arrayBuffer();
                  const result = await mammoth.extractRawText({arrayBuffer: arrayBuffer});
                  const textContent = result.value;
                  
                  console.log("从Word文档读取到文本数据，长度:", textContent.length);
                  
                  // 使用相同的文本处理逻辑
                  await processTextContent(textContent);
                } catch (error) {
                  console.error('Word文档处理错误:', error);
                  setValidationError(`处理Word文档时出错: ${error.message}\n请确保文件格式正确`);
                }
              } else {
                // 处理文本文件（CSV, TXT等）
                const fileReader = new FileReader();
                
                fileReader.onload = async (event) => {
                  try {
                    let textData = event.target.result;
                    console.log("读取到文件数据，长度:", textData.length);
                    
                    // 处理BOM标记
                    if (textData.charCodeAt(0) === 0xFEFF) {
                      textData = textData.slice(1);
                    }
                    
                    await processTextContent(textData);
                  } catch (error) {
                    console.error('文本文件处理错误:', error);
                    setValidationError(`处理文件时出错: ${error.message}\n请确保文件格式正确，并且箱号是有效的5位数字或AKE格式`);
                  }
                };
                
                fileReader.onerror = (error) => {
                  console.error('文件读取错误:', error);
                  setValidationError(`读取文件失败: ${error.message || '未知错误'}`);
                };
                
                fileReader.readAsText(importFile);
              }
            } catch (error) {
              console.error('导入过程错误:', error);
              setValidationError(`导入失败: ${error.message}`);
            }
          };

          // 处理文本内容
          const processTextContent = async (textContent) => {
            try {
              // 处理不同的行分隔符（\r\n 或 \n）
              const lines = textContent.split(/\r?\n/);
              console.log(`文件包含${lines.length}行`);
              
              // 将所有的箱号放入一个数组
              let allContainerNumbers = [];
              
              // 处理每一行 - 每行可能包含多个箱号（用逗号或空格分隔）
              lines.forEach(line => {
                // 忽略空行
                if (!line.trim()) return;
                
                // 先尝试按逗号分隔
                let numbersInLine = [];
                
                // 如果行包含逗号，按逗号分隔
                if (line.includes(',')) {
                  numbersInLine = line.split(',');
                } 
                // 否则按空格分隔
                else {
                  numbersInLine = line.split(/\s+/);
                }
                
                // 清理分割后的数据
                numbersInLine = numbersInLine
                  .map(num => num.trim())
                  .filter(num => num);
                
                // 将这一行找到的箱号添加到总数组
                allContainerNumbers = [...allContainerNumbers, ...numbersInLine];
              });
              
              // 过滤可能的标题行
              allContainerNumbers = allContainerNumbers.filter(num => 
                !String(num).toLowerCase().includes('箱号') && 
                !String(num).toLowerCase().includes('container')
              );
              
              // 预筛选：过滤明显不是箱板号的内容
              allContainerNumbers = allContainerNumbers.filter(num => {
                const str = String(num).trim()
                  .replace(/^[•·●○▪▫◦‣⁃.]/g, '') // 移除开头的符号
                  .trim();
                
                // 提取核心箱板号部分（斜杠前的部分）
                const coreNumber = str.split('/')[0].trim();
                
                // 过滤条件：
                // 1. 长度太短的（少于4个字符，航材箱至少4位）
                if (coreNumber.length < 4) return false;
                
                // 2. 检查是否是航材箱（以NO结尾）
                if (/NO$/i.test(coreNumber) && coreNumber.length >= 4) return true;
                
                // 3. 其他格式：必须以数字、AKE或PMC开头
                if (!/^(AKE|PMC|\d)/i.test(coreNumber)) return false;
                
                // 4. 只包含特殊字符或连字符的
                if (/^[-\s\t\r\n]+$/.test(coreNumber)) return false;
                
                // 5. 包含中文字符的
                if (/[\u4e00-\u9fa5]/.test(coreNumber)) return false;
                
                return true;
              });
              
              if (allContainerNumbers.length < 1) {
                setValidationError('文件为空或没有有效数据');
                return;
              }
              
              console.log(`总共找到${allContainerNumbers.length}个箱号`);
              
              const importedContainers = [];
              const errors = [];
              let skippedMaterialBoxes = 0;
              let externalOutboundCount = 0;
              
              // 处理每个箱板号
              allContainerNumbers.forEach((containerNum, index) => {
                // 去除可能的引号、空格、制表符和开头的各种圆点符号（包括普通点号）
                const cleanContainerNum = containerNum
                  .replace(/["'\t ]/g, '') // 移除引号、制表符、空格
                  .replace(/^[•·●○▪▫◦‣⁃.]/g, '') // 移除开头的各种圆点符号和普通点号
                  .trim();
                
                if (!cleanContainerNum) {
                  return; // 跳过空值
                }
                
                // 验证箱板号
                if (!validateContainerNumber(cleanContainerNum)) {
                  errors.push(`箱板号 "${cleanContainerNum}" 格式无效 (不是5-6位数字、标准AKE/PMC格式或航材箱格式)`);
                  return;
                }
                
                // 检查是否是航材箱，航材箱不录入库存
                const containerType = getContainerType(cleanContainerNum);
                if (containerType === '航材箱') {
                  skippedMaterialBoxes++;
                  console.log(`跳过航材箱: ${cleanContainerNum}`);
                  return; // 跳过航材箱，不录入库存
                }
                
                const normalizedNumber = normalizeContainerNumber(cleanContainerNum);
                
                // 如果是出港，允许外来箱板（不强制要求有进港记录）
                if (direction === '出港') {
                  const existingInbound = inventory.find(
                    item => item.containerNumber === normalizedNumber && 
                           item.direction === '进港' &&
                           !item.deletedAt
                  );
                  
                  if (!existingInbound) {
                    // 外来箱板，允许出港，只统计数量
                    externalOutboundCount++;
                    console.log(`外来出港箱板: ${cleanContainerNum}`);
                  }
                }
                
                importedContainers.push({
                  containerNumber: normalizedNumber,
                  originalInput: cleanContainerNum,
                  flightNumber: flightNumber,  // 使用导入界面设置的默认值
                  date: date,                  // 使用导入界面设置的默认值
                  direction: direction
                });
              });
              
              console.log(`成功处理${importedContainers.length}条记录，有${errors.length}个错误`);
              
              if (errors.length > 0) {
                setValidationError(`导入过程中有错误 (${errors.length}个):\n${errors.join('\n')}`);
                // 如果有些成功导入，也显示提示
                if (importedContainers.length > 0) {
                  // 尝试保存成功的记录到Supabase
                  saveToSupabase(importedContainers).then(success => {
                    if (success) {
                      setValidationError(prev => prev + `\n\n但仍成功导入了 ${importedContainers.length} 条记录`);
                    }
                  });
                }
                return;
              }
              
              if (importedContainers.length === 0) {
                setValidationError('没有找到有效的记录可导入');
                return;
              }
              
              // 保存到Supabase
              saveToSupabase(importedContainers).then(success => {
                if (success) {
                  setValidationError('');
                  setImportFile(null);
                  let message = `成功导入 ${importedContainers.length} 条${direction}记录`;
                  if (skippedMaterialBoxes > 0) {
                    message += `，跳过 ${skippedMaterialBoxes} 个航材箱`;
                  }
                  if (externalOutboundCount > 0) {
                    message += `，其中 ${externalOutboundCount} 个为外来箱板`;
                  }
                  alert(message);
                }
              });
            } catch (error) {
              console.error('文本处理错误:', error);
              setValidationError(`处理文件时出错: ${error.message}\n请确保文件格式正确，并且箱号是有效的5位数字或AKE格式`);
            }
          };

          // 批量清空所有记录（管理员功能）
          const handleClearAllRecords = async () => {
            if (currentUser?.role !== 'admin') {
              alert('只有管理员可以执行此操作');
              return;
            }
            
            if (window.confirm('确定要删除所有记录吗？此操作不可恢复！')) {
              if (window.confirm('再次确认：是否删除所有记录？')) {
                try {
                  setLoading(true);
                  const { error } = await supabase
                    .from('containers')
                    .delete()
                    .neq('id', 0);

                  if (error) {
                    throw error;
                  }

                  await loadInventory();
                  alert('所有记录已清空');
                } catch (error) {
                  console.error('清空记录失败:', error);
                  alert('清空记录失败: ' + error.message);
                } finally {
                  setLoading(false);
                }
              }
            }
          };

          // 基于时间顺序为同一箱板的进出记录进行配对
          const matchInfoMap = React.useMemo(() => {
            const result = {};
            const groupedByContainer = new Map();

            // 只处理未删除的记录
            const activeInventory = inventory.filter(record => !record.deletedAt);

            activeInventory.forEach(record => {
              const isMaterialBox = getContainerType(record.originalInput) === '航材箱';
              if (isMaterialBox) {
                result[record.id] = { matched: false, externalOutbound: false, ignore: true };
                return;
              }
              if (!groupedByContainer.has(record.containerNumber)) {
                groupedByContainer.set(record.containerNumber, []);
              }
              groupedByContainer.get(record.containerNumber).push(record);
            });

            const getSortKey = (rec) => {
              if (rec.timestamp) {
                const t = Date.parse(rec.timestamp);
                if (!Number.isNaN(t)) return t;
              }
              if (rec.date) {
                const d = Date.parse(rec.date);
                if (!Number.isNaN(d)) return d;
              }
              return rec.id || 0;
            };

            groupedByContainer.forEach(records => {
              const sorted = [...records].sort((a, b) => getSortKey(a) - getSortKey(b));
              const unmatchedInboundQueue = [];

              sorted.forEach(rec => {
                if (rec.direction === '进港') {
                  unmatchedInboundQueue.push(rec);
                  if (!result[rec.id]) result[rec.id] = { matched: false, externalOutbound: false };
                } else if (rec.direction === '出港') {
                  const hasInboundToMatch = unmatchedInboundQueue.length > 0;
                  if (hasInboundToMatch) {
                    const inboundRec = unmatchedInboundQueue.shift();
                    result[inboundRec.id] = { matched: true, externalOutbound: false };
                    result[rec.id] = { matched: true, externalOutbound: false };
                  } else {
                    result[rec.id] = { matched: false, externalOutbound: true };
                  }
                }
              });
            });

            return result;
          }, [inventory]);

          // 计算当前库存
          const currentInventory = inventory.filter(item => {
            if (item.deletedAt) return false; // 排除已删除的
            if (getContainerType(item.originalInput) === '航材箱') return false;
            if (item.direction !== '进港') return false;
            const info = matchInfoMap[item.id] || { matched: false };
            return !info.matched;
          });

          // 按类型分类当前库存
          const inventoryByType = currentInventory.reduce((acc, item) => {
            const type = getContainerType(item.originalInput);
            if (!acc[type]) acc[type] = [];
            acc[type].push(item);
            return acc;
          }, {});

          // 过滤并搜索库存
          const filteredInventory = inventory.filter(item => {
            if (!searchTerm) return true;
            return (
              item.containerNumber.includes(searchTerm) ||
              item.flightNumber.includes(searchTerm) ||
              item.date.includes(searchTerm) ||
              item.originalInput.includes(searchTerm)
            );
          });

          // 导出当前库存为CSV
          const exportInventory = () => {
            let csvContent = "箱板号,类型,航班号,日期,方向,状态\n";
            
            filteredInventory.forEach(item => {
              if (item.deletedAt) return; // 不导出已删除的记录
              
              const info = matchInfoMap[item.id] || { matched: false, externalOutbound: false };
              const status = item.direction === '进港'
                ? (info.matched ? '已出库' : '在库')
                : (info.externalOutbound ? '出港(外来)' : '出港');
              
              const containerType = getContainerType(item.originalInput);
              csvContent += `${getStandardDisplayName(item.originalInput)},${containerType},${item.flightNumber},${item.date},${item.direction},${status}\n`;
            });
            
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement("a");
            link.setAttribute("href", url);
            link.setAttribute("download", `箱板库存报表_${new Date().toISOString().slice(0,10)}.csv`);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
          };

          // 如果未登录，显示登录界面
          if (!isAuthenticated) {
            return <LoginForm onLogin={handleLogin} />;
          }

          // 主界面
          return (
            <div className="min-h-screen bg-gray-100">
              {/* 顶部导航栏 */}
              <div className="bg-white shadow-sm border-b">
                <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                  <div className="flex justify-between items-center py-4">
                    <div className="flex items-center space-x-4">
                      <h1 className="text-xl font-bold text-gray-800">航空货物箱板跟踪系统</h1>
                      <span className={`px-3 py-1 rounded-full text-xs font-semibold ${
                        currentUser?.role === 'admin' 
                          ? 'bg-red-100 text-red-800' 
                          : 'bg-blue-100 text-blue-800'
                      }`}>
                        {currentUser?.role === 'admin' ? '管理员' : '普通用户'}
                      </span>
                    </div>
                    <div className="flex items-center space-x-4">
                      <span className="text-gray-600">
                        欢迎，{currentUser?.displayName || currentUser?.username}
                      </span>
                      <button
                        onClick={handleLogout}
                        className="bg-red-500 text-white px-4 py-2 rounded hover:bg-red-600 text-sm"
                      >
                        退出登录
                      </button>
                    </div>
                  </div>
                </div>
              </div>

              <div className="p-4 max-w-7xl mx-auto">
                {/* 导航菜单 */}
                <div className="flex mb-6 bg-gray-100 rounded-lg overflow-hidden">
                  <button 
                    onClick={() => setCurrentView('form')}
                    className={`flex-1 py-2 px-4 ${currentView === 'form' ? 'bg-blue-500 text-white' : ''}`}
                  >
                    记录箱板
                  </button>
                  <button 
                    onClick={() => setCurrentView('inventory')}
                    className={`flex-1 py-2 px-4 ${currentView === 'inventory' ? 'bg-blue-500 text-white' : ''}`}
                  >
                    查看库存
                  </button>
                  <button 
                    onClick={() => setCurrentView('import')}
                    className={`flex-1 py-2 px-4 ${currentView === 'import' ? 'bg-blue-500 text-white' : ''}`}
                  >
                    批量导入箱板
                  </button>
                  <button 
                    onClick={() => setCurrentView('password')}
                    className={`flex-1 py-2 px-4 ${currentView === 'password' ? 'bg-blue-500 text-white' : ''}`}
                  >
                    密码管理
                  </button>
                </div>

                {/* 加载指示器 */}
                {loading && (
                  <div className="bg-blue-100 border border-blue-400 text-blue-700 px-4 py-3 rounded mb-4 text-center">
                    <div className="inline-flex items-center">
                      <svg className="animate-spin -ml-1 mr-3 h-5 w-5 text-blue-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                        <circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4"></circle>
                        <path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                      </svg>
                      正在处理...
                    </div>
                  </div>
                )}

                {/* 错误信息显示 */}
                {validationError && (
                  <div className="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded mb-4 whitespace-pre-line">
                    {validationError}
                  </div>
                )}

                {/* 记录箱子表单 */}
                {currentView === 'form' && (
                  <div className="bg-white p-6 rounded-lg shadow-md">
                    <h2 className="text-xl font-semibold mb-4">记录箱板信息</h2>
                    
                    <div className="mb-4">
                      <label className="block text-gray-700 mb-2">箱板号</label>
                      <input
                        type="text"
                        className="w-full px-3 py-2 border rounded"
                        placeholder="输入箱板号，多个用逗号分隔"
                        value={containerNumber}
                        onChange={(e) => setContainerNumber(e.target.value)}
                      />
                    </div>
                    
                    <div className="mb-4">
                      <label className="block text-gray-700 mb-2">航班号</label>
                      <input
                        type="text"
                        className="w-full px-3 py-2 border rounded"
                        placeholder="输入航班号"
                        value={flightNumber}
                        onChange={(e) => setFlightNumber(e.target.value)}
                      />
                    </div>
                    
                    <div className="mb-4">
                      <label className="block text-gray-700 mb-2">日期</label>
                      <input
                        type="date"
                        className="w-full px-3 py-2 border rounded"
                        value={date}
                        onChange={(e) => setDate(e.target.value)}
                      />
                    </div>
                    
                    <div className="mb-4">
                      <label className="block text-gray-700 mb-2">方向</label>
                      <select
                        className="w-full px-3 py-2 border rounded"
                        value={direction}
                        onChange={(e) => setDirection(e.target.value)}
                      >
                        <option value="进港">进港</option>
                        <option value="出港">出港</option>
                      </select>
                    </div>
                    
                    <button
                      className="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600"
                      onClick={handleAddContainer}
                    >
                      添加记录
                    </button>
                  </div>
                )}

                {/* 库存视图 */}
                {currentView === 'inventory' && (
                  <div className="bg-white p-6 rounded-lg shadow-md">
                    <div className="flex justify-between items-center mb-4">
                      <h2 className="text-xl font-semibold">库存信息</h2>
                      <div className="flex items-center space-x-4">
                        <div className="text-green-600 font-semibold">
                          当前库存: {currentInventory.length} 箱板
                        </div>
                        {currentUser?.role === 'admin' && (
                          <label className="flex items-center space-x-2">
                            <input
                              type="checkbox"
                              checked={showDeleted}
                              onChange={(e) => setShowDeleted(e.target.checked)}
                              className="rounded"
                            />
                            <span className="text-sm text-gray-600">显示已删除记录</span>
                          </label>
                        )}
                      </div>
                    </div>
                    
                    {/* 按类型分类统计 */}
                    <div className="mb-4 p-4 bg-gray-50 rounded-lg">
                      <h3 className="font-medium mb-2 text-gray-700">库存分类统计</h3>
                      <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
                        {Object.entries(inventoryByType).map(([type, items]) => (
                          <div key={type} className="text-center">
                            <div className={`text-lg font-bold ${
                              type === 'AKE' ? 'text-blue-600' : 
                              type === 'PMC' ? 'text-green-600' : 
                              type === '数字' ? 'text-orange-600' : 'text-gray-600'
                            }`}>
                              {items.length}
                            </div>
                            <div className="text-sm text-gray-600">{type}箱板</div>
                          </div>
                        ))}
                        {Object.keys(inventoryByType).length === 0 && (
                          <div className="col-span-full text-center text-gray-500">
                            暂无库存
                          </div>
                        )}
                      </div>
                    </div>
                    
                    {/* 搜索和导出 */}
                    <div className="flex mb-4 gap-2">
                      <div className="relative flex-1">
                        <input
                          type="text"
                          className="w-full px-3 py-2 pr-10 border rounded"
                          placeholder="搜索箱板号、航班号或日期..."
                          value={searchTerm}
                          onChange={(e) => setSearchTerm(e.target.value)}
                        />
                        {searchTerm && (
                          <button
                            type="button"
                            className="absolute right-2 top-1/2 transform -translate-y-1/2 text-gray-400 hover:text-gray-600 focus:outline-none"
                            onClick={() => setSearchTerm('')}
                            title="清除搜索"
                          >
                            <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M6 18L18 6M6 6l12 12"></path>
                            </svg>
                          </button>
                        )}
                      </div>
                      <button
                        className="bg-green-500 text-white px-4 py-2 rounded hover:bg-green-600"
                        onClick={exportInventory}
                      >
                        导出CSV
                      </button>
                      {currentUser?.role === 'admin' && (
                        <button
                          className="bg-red-500 text-white px-4 py-2 rounded hover:bg-red-600"
                          onClick={handleClearAllRecords}
                        >
                          清空所有
                        </button>
                      )}
                    </div>
                    
                    {/* 库存表格 */}
                    <div className="overflow-x-auto">
                      <table className="min-w-full bg-white">
                        <thead>
                          <tr className="bg-gray-100">
                            <th className="px-4 py-2 text-left">箱板号</th>
                            <th className="px-4 py-2 text-left">类型</th>
                            <th className="px-4 py-2 text-left">航班号</th>
                            <th className="px-4 py-2 text-left">日期</th>
                            <th className="px-4 py-2 text-left">方向</th>
                            <th className="px-4 py-2 text-left">状态</th>
                            <th className="px-4 py-2 text-left">操作</th>
                          </tr>
                        </thead>
                        <tbody>
                          {filteredInventory.map((item) => {
                            const info = matchInfoMap[item.id] || { matched: false, externalOutbound: false };
                            const status = item.deletedAt 
                              ? '已删除'
                              : item.direction === '进港'
                                ? (info.matched ? '已出库' : '在库')
                                : (info.externalOutbound ? '出港(外来)' : '出港');
                            
                            const containerType = getContainerType(item.originalInput);
                            const isDeleted = !!item.deletedAt;
                            
                            return (
                              <tr key={item.id} className={`border-t ${isDeleted ? 'bg-gray-50 opacity-60' : ''}`}>
                                <td className="px-4 py-2">{getStandardDisplayName(item.originalInput)}</td>
                                <td className={`px-4 py-2 font-medium ${
                                  containerType === 'AKE' ? 'text-blue-600' : 
                                  containerType === 'PMC' ? 'text-green-600' : 
                                  containerType === '数字' ? 'text-orange-600' : 
                                  containerType === '航材箱' ? 'text-purple-600' : 'text-gray-600'
                                }`}>
                                  {containerType}
                                </td>
                                <td className="px-4 py-2">{item.flightNumber}</td>
                                <td className="px-4 py-2">{item.date}</td>
                                <td className="px-4 py-2">{item.direction}</td>
                                <td className={`px-4 py-2 ${
                                  isDeleted ? 'text-red-600' :
                                  status === '在库' ? 'text-green-600' : 
                                  status.includes('外来') ? 'text-orange-600 font-medium' : 'text-gray-600'
                                }`}>
                                  {status}
                                  {isDeleted && item.deletedBy && (
                                    <div className="text-xs text-gray-500">
                                      被 {item.deletedBy} 删除
                                    </div>
                                  )}
                                </td>
                                <td className="px-4 py-2">
                                  <div className="flex space-x-2">
                                    {!isDeleted && (
                                      <>
                                        {currentUser?.role === 'admin' ? (
                                          <button 
                                            onClick={() => handlePermanentDelete(item.id)}
                                            className="bg-red-500 text-white px-2 py-1 rounded text-xs hover:bg-red-600"
                                            title="永久删除"
                                          >
                                            永久删除
                                          </button>
                                        ) : (
                                          <button 
                                            onClick={() => handleSoftDelete(item.id)}
                                            className="bg-orange-500 text-white px-2 py-1 rounded text-xs hover:bg-orange-600"
                                            title="软删除"
                                          >
                                            删除
                                          </button>
                                        )}
                                      </>
                                    )}
                                    {isDeleted && currentUser?.role === 'admin' && (
                                      <>
                                        <button 
                                          onClick={() => handleRestore(item.id)}
                                          className="bg-green-500 text-white px-2 py-1 rounded text-xs hover:bg-green-600"
                                          title="恢复记录"
                                        >
                                          恢复
                                        </button>
                                        <button 
                                          onClick={() => handlePermanentDelete(item.id)}
                                          className="bg-red-700 text-white px-2 py-1 rounded text-xs hover:bg-red-800"
                                          title="彻底删除"
                                        >
                                          彻底删除
                                        </button>
                                      </>
                                    )}
                                  </div>
                                </td>
                              </tr>
                            );
                          })}
                          {filteredInventory.length === 0 && (
                            <tr>
                              <td colSpan="7" className="px-4 py-2 text-center">没有找到记录</td>
                            </tr>
                          )}
                        </tbody>
                      </table>
                    </div>
                  </div>
                )}

                {/* 导入箱板数据 */}
                {currentView === 'import' && (
                  <div className="bg-white p-6 rounded-lg shadow-md">
                    <h2 className="text-xl font-semibold mb-4">批量导入箱板数据</h2>
                    
                    <div className="mb-4 p-3 bg-green-50 border border-green-200 rounded">
                      <p className="text-sm text-green-700">
                        ✅ <strong>现在支持外来箱板出港：</strong>批量导入时，出港箱板不再要求必须有对应的进港记录。
                      </p>
                    </div>
                    
                    <div className="mb-4">
                      <label className="block text-gray-700 mb-2">选择进/出港方向</label>
                      <select
                        className="w-full px-3 py-2 border rounded mb-4"
                        value={direction}
                        onChange={(e) => setDirection(e.target.value)}
                      >
                        <option value="进港">进港</option>
                        <option value="出港">出港</option>
                      </select>
                      
                      <div className="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                        <div>
                          <label className="block text-gray-700 mb-2">默认航班号 (必填)</label>
                          <input
                            type="text"
                            className="w-full px-3 py-2 border rounded"
                            placeholder="输入默认航班号"
                            value={flightNumber}
                            onChange={(e) => setFlightNumber(e.target.value)}
                          />
                        </div>
                        <div>
                          <label className="block text-gray-700 mb-2">默认日期 (必填)</label>
                          <input
                            type="date"
                            className="w-full px-3 py-2 border rounded"
                            value={date}
                            onChange={(e) => setDate(e.target.value)}
                          />
                        </div>
                      </div>
                      
                      <label className="block text-gray-700 mb-2">选择文件</label>
                      <input
                        type="file"
                        accept=".csv,.txt,.xls,.xlsx,.doc,.docx"
                        onChange={handleFileImport}
                        className="w-full"
                      />
                      <p className="text-sm text-gray-500 mt-1">
                        支持Word文档(.doc, .docx)、Excel文件(.xls, .xlsx)、CSV文件(.csv)或文本文件(.txt)
                      </p>
                    </div>
                    
                    <button
                      className="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600"
                      onClick={processImport}
                    >
                      导入数据
                    </button>
                    
                    <div className="mt-4 p-4 bg-gray-50 rounded">
                      <h3 className="font-medium mb-2 text-red-600">使用说明</h3>
                      <ol className="list-decimal pl-5 text-sm mb-4">
                        <li className="mb-1">文件中的箱板号可以是一行一个，也可以是一行多个（空格或逗号分隔）</li>
                        <li className="mb-1">箱板号必须是<strong>精确的5-6位数字</strong>、标准AKE格式、PMC格式或<strong>航材箱格式</strong>(以NO结尾)</li>
                        <li className="mb-1">支持带位置信息的完整格式（如AKE12345R7/NKG/B），系统会自动提取核心箱板号</li>
                        <li className="mb-1">输入正确的默认航班号和日期</li>
                        <li className="mb-1">系统会自动识别所有箱板号并忽略无效内容和文档格式符号</li>
                        <li className="mb-1">支持多种文件格式：Word文档、Excel文件、CSV文件、文本文件</li>
                        <li className="mb-1">支持箱板号前面的小圆点符号或普通点号，系统会自动忽略</li>
                        <li className="mb-1">系统会自动过滤掉明显无关的内容（如标题、符号、短字符串等）</li>
                        <li className="mb-1"><strong className="text-red-600">航材箱（以NO结尾或位置信息以E结尾）会被自动忽略，不录入库存</strong></li>
                        <li className="mb-1">显示时只保留标准格式（如AKE12345R7），自动去除位置信息</li>
                        <li className="mb-1 text-green-600 font-medium">✅ <strong>外来箱板可以直接出港，不需要进港记录</strong></li>
                      </ol>
                      
                      <div className="mt-3">
                        <h4 className="font-medium text-blue-600">支持的文件格式</h4>
                        <div className="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                          <div>
                            <p className="text-sm font-medium text-green-600">Word文档</p>
                            <p className="text-xs text-gray-600">.doc, .docx<br/>直接从Word文档中提取文本内容</p>
                          </div>
                          <div>
                            <p className="text-sm font-medium text-blue-600">Excel文件</p>
                            <p className="text-xs text-gray-600">.xls, .xlsx<br/>需要先导出为CSV格式</p>
                          </div>
                          <div>
                            <p className="text-sm font-medium text-orange-600">文本文件</p>
                            <p className="text-xs text-gray-600">.csv, .txt<br/>纯文本格式</p>
                          </div>
                        </div>
                        
                        <h4 className="font-medium text-blue-600">文件内容格式示例</h4>
                        <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                          <div>
                            <p className="text-sm font-medium">格式一：每行一个箱板号</p>
                            <pre className="text-sm bg-gray-100 p-2 rounded mt-1 overflow-x-auto">
                              12345<br/>
                              035121<br/>
                              AKE12345R7<br/>
                              PMC56789R9<br/>
                              • AKE67890R7<br/>
                              .AKE035121R7<br/>
                              .PMC11729R9<br/>
                              AKE38240R7/NKG/BF<br/>
                              PMC11729R9/NKG/C<br/>
                              <span className="text-red-500">AKE00004NO/NKG/E (被忽略)</span><br/>
                              <span className="text-red-500">1234NO (被忽略)</span><br/>
                              67890
                            </pre>
                          </div>
                          <div>
                            <p className="text-sm font-medium">格式二：空格分隔的多个箱板号</p>
                            <pre className="text-sm bg-gray-100 p-2 rounded mt-1 overflow-x-auto">
                              12345 56789 67890<br/>
                              AKE12345R7 PMC34567R9<br/>
                              • AKE23456R7 78901<br/>
                              .PMC09265R7 .AKE78590R7<br/>
                              AKE66699R7/NKG/B PMC08240R7/NKG/C<br/>
                              <span className="text-red-500">1234NO 5678NO (被忽略)</span><br/>
                              PMC11111R9 22222
                            </pre>
                            <p className="text-xs text-red-500 mt-2">
                              红色标注的航材箱会被自动忽略，不录入库存
                            </p>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                )}

                {/* 密码管理 */}
                {currentView === 'password' && (
                  <div className="bg-white p-6 rounded-lg shadow-md">
                    <h2 className="text-xl font-semibold mb-4">密码管理</h2>
                    
                    {currentUser?.role === 'admin' ? (
                      // 管理员界面
                      <AdminPasswordManager currentUser={currentUser} />
                    ) : (
                      // 普通用户界面
                      <UserPasswordManager currentUser={currentUser} onPasswordChange={() => {
                        // 密码修改成功后，清除保存的登录信息，需要重新登录
                        handleLogout();
                        alert('密码修改成功！请使用新密码重新登录。');
                      }} />
                    )}
                  </div>
                )}
              </div>
            </div>
          );
        };

        // 将组件渲染到DOM
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<ContainerTrackingSystem />);
    </script>
</body>
</html>
